---
format: html
---

```{=html}
<div style="margin-top: 1em; text-align:center;">
  <button id="start-session" class="btn btn-primary">Start</button>
</div>

<div id="countdown" style="font-weight:bold; font-size:1.5em; margin:1em 0; text-align:center;"></div>

<div style="display:flex; justify-content:space-between; align-items:flex-start;">
  <video id="video" autoplay style="border:2px solid #ccc; border-radius:5px; width:640px; height:480px; margin-right:20px;"></video>
  <div id="strip" style="
    display:flex; 
    flex-direction:row; 
    flex-wrap:wrap;
    align-items:center; 
    justify-content: space-around;
    border:2px solid #ccc; 
    padding:10px; 
    background:#fff;
    width: 380px;
  ">
    <!-- Photos will be displayed here -->
  </div>
</div>

<script>
  const startBtn = document.getElementById('start-session');
  const countdownEl = document.getElementById('countdown');
  const video = document.getElementById('video');
  const strip = document.getElementById('strip');

  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = stream;
    } catch (err) {
      console.error('Error accessing camera:', err);
      alert('Could not access camera. Please allow camera access.');
    }
  }

  function storePhoto(dataUrl) {
    let photos = JSON.parse(localStorage.getItem('photostripImages')) || [];
    photos.push(dataUrl);
    localStorage.setItem('photostripImages', JSON.stringify(photos));
  }

  function capturePhoto() {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = 180;
    canvas.height = 135;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/png');
    const img = new Image();
    img.src = dataUrl;
    img.style.width = "150px";
    img.style.height = "112.5px";
    img.style.margin = '10px';
    strip.appendChild(img);
    
    storePhoto(dataUrl);
  }

  async function startSession() {
    strip.innerHTML = '';  // Clear previous photos
    localStorage.removeItem('photostripImages');  // Clear any previous session images
    startBtn.disabled = true;
    startBtn.innerText = "Shooting in progress";

    const totalShots = 4;
    for (let i = 1; i <= totalShots; i++) {
      countdownEl.textContent = `3...`;
      await new Promise(resolve => setTimeout(resolve, 1000));
      countdownEl.textContent = `2...`;
      await new Promise(resolve => setTimeout(resolve, 1000));
      countdownEl.textContent = `1...`;
      await new Promise(resolve => setTimeout(resolve, 1000));

      capturePhoto();
      countdownEl.textContent = `Shot #${i} taken!`;
      if (i === totalShots) {  // After the last photo, redirect
          redirectToPhotostrip();
      }
    }

    countdownEl.textContent = "";  // Clear countdown
    startBtn.innerText = "Start";
    startBtn.disabled = false;
  }

  initCamera();
  startBtn.addEventListener('click', startSession);

  function redirectToPhotostrip() {
    window.location.href = 'photostrip.html';  // Redirect to the page where the photostrip is displayed
  }
</script>
```
